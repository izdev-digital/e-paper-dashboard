@page
@model EPaperDashboard.Pages.Users.ManageModel
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "SuperUserOnly")]
@{
    ViewData["Title"] = "User Management";
}

<h2>User Management</h2>

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="card-title mb-3">Add New User</h5>
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger mb-3">@Model.ErrorMessage</div>
        }
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success mb-3">@Model.SuccessMessage</div>
        }
        <form method="post" asp-page-handler="Add">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" asp-for="NewUsername" required />
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" asp-for="NewPassword" required />
            </div>
            <button type="submit" class="btn btn-success">Add User</button>
        </form>
    </div>
</div>

<div class="mb-4">
    <input type="text" id="userSearchInput" class="form-control" placeholder="Search users by username..." oninput="filterUsers()">
</div>

<div class="row row-cols-1 g-3 mb-4" id="userTiles">
@foreach (var user in Model.Users)
{
    <div class="col user-tile" data-username="@user.Username.ToLower()">
        <div class="card h-100 shadow-sm w-100">
            <div class="card-body d-flex flex-row align-items-center justify-content-between">
                <div>
                    <h5 class="card-title mb-1">@user.Username</h5>
                    <span class="badge bg-@(user.IsSuperUser ? "primary" : "secondary")">@(user.IsSuperUser ? "Superuser" : "User")</span>
                </div>
                @if (!user.IsSuperUser)
                {
                    <a asp-page="/Users/Delete" asp-route-id="@user.Id.ToString()" class="btn btn-danger btn-sm ms-auto">Delete</a>
                }
            </div>
        </div>
    </div>
}
</div>
<script>
function filterUsers() {
    const input = document.getElementById('userSearchInput');
    const filter = input.value.toLowerCase();
    const tiles = document.querySelectorAll('.user-tile');
    tiles.forEach(tile => {
        const username = tile.getAttribute('data-username');
        tile.style.display = username.includes(filter) ? '' : 'none';
    });
}
</script>

<style>
.card-title {
    font-size: 1.1rem;
    font-weight: 500;
}
.card .btn-danger {
    float: right;
}
</style>
