@page "{id}"
@model EPaperDashboard.Pages.Dashboards.EditModel
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@{
    ViewData["Title"] = "Edit Dashboard";
}

<h2>Edit Dashboard</h2>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (!string.IsNullOrEmpty(Model.AuthSuccessToken))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        Successfully authenticated with Home Assistant! The access token has been populated below.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.AuthError))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        Authentication failed: @Model.AuthError
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form method="post" data-api-key="@Model.ApiKey">
    <input type="hidden" asp-for="Id" />
    <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" class="form-control" asp-for="Name" required />
    </div>
    <div class="mb-3">
        <label class="form-label">Description</label>
        <input type="text" class="form-control" asp-for="Description" />
    </div>
    <div class="mb-3">
        <label class="form-label">API Key</label>
        <div class="input-group">
            <input type="text" class="form-control" id="apiKeyField" asp-for="ApiKey" readonly tabindex="-1" style="pointer-events: none;" />
            <button type="button" class="btn btn-outline-secondary" title="Copy API Key" onclick="copyApiKey('@Model.ApiKey')">
                <i class="fa-regular fa-clipboard"></i>
            </button>
        </div>
    </div>
    <fieldset class="border rounded p-3 mb-3">
        <legend class="w-auto px-2" style="font-size:1.1em;">Home Assistant Dashboard</legend>
        <div class="mb-3">
            <label class="form-label">Dashboard Host</label>
            <input type="text" class="form-control" asp-for="Host" />
        </div>
        <div class="mb-3">
            <label class="form-label">Access Token</label>
            <div class="input-group">
                <input type="text" class="form-control" asp-for="AccessToken" id="accessTokenField" placeholder="Enter token to update..." value="@(Model.AuthSuccessToken ?? Model.AccessToken)" />
                <button type="button" class="btn btn-outline-primary" id="fetchTokenBtn" title="Authenticate with Home Assistant" onclick="authenticateWithHomeAssistant(event)">
                    <i class="fa-solid fa-key"></i> Fetch Token
                </button>
                <button type="button" class="btn btn-outline-danger" id="cancelFetchBtn" title="Cancel authentication" onclick="cancelHomeAssistantAuth(event)" style="display: none;">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Dashboard Path</label>
            <input type="text" class="form-control" asp-for="Path" />
        </div>
        <div class="mb-3">
            <label class="form-label">Update Times</label>
            <div class="d-flex align-items-center mb-2">
                <input type="time" id="updateTimeInput" class="form-control me-2" style="width: 150px;">
                <button type="button" class="btn btn-outline-primary" onclick="addUpdateTime()">Add</button>
            </div>
            <div id="updateTimesList" class="mb-2">
            </div>
            <input type="hidden" name="UpdateTimesRaw" id="UpdateTimesRaw" value="@Model.UpdateTimesRaw" />
            <div class="form-text">Add one or more times. Example: 06:00, 12:00, 18:00</div>
        </div>
    </fieldset>
    <div class="mb-5 pb-3">
        <button type="submit" class="btn btn-primary" id="saveButton" disabled>Save</button>
        <a asp-page="/Dashboards" class="btn btn-secondary ms-2">Cancel</a>
        <button type="button" class="btn btn-info ms-2" onclick="previewDashboard()">
            <i class="fa-solid fa-eye"></i> Preview
        </button>
    </div>
</form>

<div id="copy-toast" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-4" role="alert" aria-live="assertive" aria-atomic="true" style="display:none; z-index: 1080;">
    <div class="d-flex">
        <div class="toast-body">
            API Key copied to clipboard!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close" onclick="hideCopyToast()"></button>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="position-fixed top-0 start-0 w-100 h-100" style="display:none; background-color: rgba(0,0,0,0.5); z-index: 1050; overflow: hidden;">
    <div class="position-absolute top-50 start-50 translate-middle rounded" style="width: 90vw; height: 90vh; max-width: 900px; max-height: 600px; display: flex; flex-direction: column; background-color: var(--bs-body-bg); color: var(--bs-body-color); border: 1px solid var(--bs-border-color);">
        <!-- Modal Header -->
        <div class="d-flex justify-content-between align-items-center p-3" style="border-bottom: 1px solid var(--bs-border-color);">
            <h5 class="mb-0">Dashboard Preview</h5>
            <div class="preview-modal-header-btns">
                <button type="button" class="btn btn-sm me-2 preview-reload-btn" title="Reload Preview" onclick="previewDashboard()">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
                <button type="button" class="btn-close" aria-label="Close" onclick="closePreviewModal()"></button>
            </div>
        </div>
        <!-- Modal Body -->
        <div class="flex-grow-1 overflow-auto p-3" id="preview-container" style="display: flex; justify-content: center; align-items: flex-start; background-color: var(--bs-secondary-bg);">
            <img id="preview-image" style="max-width: 100%; height: auto; object-fit: contain;" />
        </div>
        <!-- Modal Footer -->
        <div id="preview-error" class="alert alert-danger mb-0" style="display:none;"></div>
    </div>
</div>

<style>
    #updateTimesList .badge {
        display: inline-flex;
        align-items: center;
        font-size: 1rem;
        padding: 0.5em 0.75em;
    }
    #updateTimesList .btn-close {
        margin-left: 0.25em;
        margin-right: 0;
        margin-top: 0;
        margin-bottom: 0;
        vertical-align: middle;
    }
    /* Modal header buttons */
    .preview-modal-header-btns {
        display: flex;
        align-items: center;
    }
    .preview-modal-header-btns .preview-reload-btn {
        border: 0;
        background: transparent;
        padding: 0.25rem 0.4rem;
        line-height: 1;
    }
    .preview-modal-header-btns .preview-reload-btn:focus {
        box-shadow: none;
    }
    
    /* API Key field readonly styling for dark mode */
    #apiKeyField:read-only {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
    }
    
    #apiKeyField:read-only:disabled {
        opacity: 1;
    }
</style>

<script src="~/js/clipboard-utils.js"></script>
<script>
    let updateTimesRaw = '@(Model.UpdateTimesRaw ?? "")';
    let updateTimes = updateTimesRaw ? updateTimesRaw.split(',').filter(t => t) : [];
    const initialUpdateTimes = [...updateTimes];
    
    const saveButton = document.getElementById('saveButton');
    
    function checkForChanges() {
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input[type="text"]:not([readonly])');
        
        // Check if any input value differs from its defaultValue
        const hasInputChanges = Array.from(inputs).some(input => {
            return input.value !== input.defaultValue;
        });
        
        // Check if update times have changed
        const updateTimesChanged = updateTimes.join(',') !== initialUpdateTimes.join(',');
        
        const hasChanges = hasInputChanges || updateTimesChanged;
        
        if (saveButton) {
            saveButton.disabled = !hasChanges;
        }
    }
    
    function setupChangeTracking() {
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input[type="text"]:not([readonly])');
        
        inputs.forEach(input => {
            input.addEventListener('input', checkForChanges);
        });
    }
    
    function renderUpdateTimes() {
        const list = document.getElementById('updateTimesList');
        list.innerHTML = '';
        updateTimes.forEach((t, idx) => {
            const chip = document.createElement('span');
            chip.className = 'badge bg-primary me-1 mb-1';
            chip.textContent = t + ' ';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-close btn-close-white btn-sm ms-1';
            btn.onclick = () => { updateTimes.splice(idx, 1); renderUpdateTimes(); checkForChanges(); };
            chip.appendChild(btn);
            list.appendChild(chip);
        });
        document.getElementById('UpdateTimesRaw').value = updateTimes.join(',');
    }
    function addUpdateTime() {
        const input = document.getElementById('updateTimeInput');
        const val = input.value;
        if (val && !updateTimes.includes(val)) {
            updateTimes.push(val);
            updateTimes.sort();
            renderUpdateTimes();
            checkForChanges();
        }
        input.value = '';
    }
    
    // Track authentication state and abort controller
    let authInProgress = false;
    let authAbortController = null;
    let authDashboardId = null;
    
    async function authenticateWithHomeAssistant(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const hostField = document.querySelector('input[name="Host"]');
        const dashboardIdField = document.querySelector('input[name="Id"]');
        const nameField = document.querySelector('input[name="Name"]');
        const form = document.querySelector('form');
        const host = hostField?.value?.trim();
        const dashboardId = dashboardIdField?.value;
        const name = nameField?.value?.trim();
        
        if (!host) {
            hostField?.classList.add('is-invalid');
            hostField?.focus();
            
            let feedback = hostField?.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                hostField?.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Please enter Dashboard Host before authenticating';
            
            const removeHighlight = () => {
                hostField?.classList.remove('is-invalid');
                feedback?.remove();
                hostField?.removeEventListener('input', removeHighlight);
            };
            hostField?.addEventListener('input', removeHighlight);
            return;
        }
        
        if (!name) {
            alert('Please enter a Dashboard Name before authenticating');
            nameField?.focus();
            return;
        }
        
        const fetchButton = document.getElementById('fetchTokenBtn');
        const cancelButton = document.getElementById('cancelFetchBtn');
        const originalHtml = fetchButton.innerHTML;
        
        authAbortController = new AbortController();
        authInProgress = true;
        authDashboardId = dashboardId;
        
        try {
            fetchButton.disabled = true;
            fetchButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            cancelButton.style.display = 'inline-block';
            
            const formData = new FormData(form);
            try {
                const saveResponse = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    signal: authAbortController.signal
                });
                
                if (!saveResponse.ok) {
                    console.warn('Dashboard save failed, continuing with auth anyway');
                }
            } catch (saveError) {
                if (saveError.name !== 'AbortError') {
                    console.warn('Dashboard save error, continuing with auth anyway:', saveError);
                } else {
                    throw saveError;
                }
            }
            
            fetchButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting auth...';
            
            const response = await fetch('/api/homeassistant/start-auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ host: host, dashboardId: dashboardId }),
                signal: authAbortController.signal
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP Error ${response.status}`);
            }
            
            const data = await response.json();
            
            if (authAbortController && authAbortController.signal.aborted) {
                console.log('Authentication was cancelled before redirect');
                return;
            }
            
            window.location.href = data.authUrl;
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Authentication cancelled by user');
                authInProgress = false;
                authAbortController = null;
                authDashboardId = null;
                if (fetchButton) {
                    fetchButton.disabled = false;
                    fetchButton.innerHTML = originalHtml;
                }
                if (cancelButton) {
                    cancelButton.style.display = 'none';
                }
                return;
            }
            
            console.error('Authentication error:', error);
            alert('Authentication failed: ' + error.message);
            
            authInProgress = false;
            authAbortController = null;
            authDashboardId = null;
            if (fetchButton) {
                fetchButton.disabled = false;
                fetchButton.innerHTML = originalHtml;
            }
            if (cancelButton) {
                cancelButton.style.display = 'none';
            }
        }
    }
    
    function cancelHomeAssistantAuth(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const fetchButton = document.getElementById('fetchTokenBtn');
        const cancelButton = document.getElementById('cancelFetchBtn');
        const originalHtml = '<i class="fa-solid fa-key"></i> Fetch Token';
        
        if (authAbortController) {
            authAbortController.abort();
        }
        
        try {
            window.stop();
        } catch (e) {
            document.execCommand('Stop');
        }
        
        authInProgress = false;
        authAbortController = null;
        authDashboardId = null;
        
        if (fetchButton) {
            fetchButton.disabled = false;
            fetchButton.innerHTML = originalHtml;
        }
        if (cancelButton) {
            cancelButton.disabled = false;
            cancelButton.innerHTML = '<i class="fa-solid fa-times"></i> Cancel';
            cancelButton.style.display = 'none';
        }
    }
    
    // Track created object URL so we can revoke it when closing/resetting
    let _previewObjectUrl = null;
    // Track preview attempts to ignore stale load/error handlers
    let _previewAttempt = 0;

    async function previewDashboard() {
        const attempt = ++_previewAttempt;
        const modal = document.getElementById('preview-modal');
        const errorDiv = document.getElementById('preview-error');
        const container = document.getElementById('preview-container');
        const imageElement = document.getElementById('preview-image');

        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        if (_previewObjectUrl) {
            try { 
                URL.revokeObjectURL(_previewObjectUrl); 
            } catch (e) 
            { }
            _previewObjectUrl = null;
        }
        imageElement.src = '';

        modal.style.display = 'block';
        modal.style.zIndex = 2000;
        container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

        try {
            const dashboardIdInput = document.querySelector('input[name="Id"]');
            const dashboardId = dashboardIdInput ? dashboardIdInput.value : null;
            const apiKey = document.querySelector('form').dataset.apiKey || '';
            if (!dashboardId) {
                throw new Error('Dashboard ID not found');
            }
            if (!apiKey) {
                throw new Error('API Key not found');
            }

            const url = `/api/render/original?width=800&height=480&format=png`;
            const response = await fetch(url, { headers: { 'X-Api-Key': apiKey } });

            if (!response.ok) {
                let errorMessage = `HTTP Error ${response.status}: Failed to render preview`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                }
                throw new Error(errorMessage);
            }

            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            _previewObjectUrl = imageUrl;

            container.innerHTML = '';
            const img = document.createElement('img');
            img.id = 'preview-image';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'contain';
            img.alt = 'Dashboard preview';
            img.onload = function() {
                if (attempt !== _previewAttempt) return;
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            };
            img.onerror = function() {
                if (attempt !== _previewAttempt) return;
                errorDiv.textContent = 'Error: failed to load image data';
                errorDiv.style.display = 'block';
            };
            img.src = imageUrl;
            container.appendChild(img);
        } catch (error) {
            modal.style.display = 'block';
            container.innerHTML = '';
            if (attempt === _previewAttempt) {
                errorDiv.textContent = 'Error: ' + (error && error.message ? error.message : String(error));
                errorDiv.style.display = 'block';
            }
            try { document.getElementById('preview-modal').focus(); } catch (e) { }
        }
    }
    
    function closePreviewModal() {
        const modal = document.getElementById('preview-modal');
        const container = document.getElementById('preview-container');
        const errorDiv = document.getElementById('preview-error');
        const img = document.getElementById('preview-image');

        modal.style.display = 'none';

        try {
            if (typeof _previewObjectUrl === 'string' && _previewObjectUrl) {
                URL.revokeObjectURL(_previewObjectUrl);
            }
        } catch (e) { }
        _previewObjectUrl = null;
        if (img) { img.src = ''; }

        container.innerHTML = '<img id="preview-image" style="max-width: 100%; height: auto; object-fit: contain;" />';

        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
    }
    
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('preview-modal');
        if (event.target === modal) {
            closePreviewModal();
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        renderUpdateTimes();
        setupChangeTracking();
    });
</script>
