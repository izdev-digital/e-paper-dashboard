@page "{id}"
@model EPaperDashboard.Pages.Dashboards.EditModel
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@{
    ViewData["Title"] = "Edit Dashboard";
}

<h2>Edit Dashboard</h2>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

@if (!string.IsNullOrEmpty(Model.AuthSuccessToken))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        Successfully authenticated with Home Assistant! The access token has been populated below.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.AuthError))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        Authentication failed: @Model.AuthError
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form method="post" data-api-key="@Model.ApiKey">
    <input type="hidden" asp-for="Id" />
    <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" class="form-control" asp-for="Name" required />
    </div>
    <div class="mb-3">
        <label class="form-label">Description</label>
        <input type="text" class="form-control" asp-for="Description" />
    </div>
    <div class="mb-3">
        <label class="form-label">API Key</label>
        <div class="input-group">
            <input type="text" class="form-control" id="apiKeyField" asp-for="ApiKey" readonly tabindex="-1" style="pointer-events: none;" />
            <button type="button" class="btn btn-outline-secondary" title="Copy API Key" onclick="copyApiKey('@Model.ApiKey')">
                <i class="fa-regular fa-clipboard"></i>
            </button>
        </div>
    </div>
    <fieldset class="border rounded p-3 mb-3">
        <legend class="w-auto px-2" style="font-size:1.1em;">Hass Dashboard</legend>
        <div class="mb-3">
            <label class="form-label">Access Token</label>
            <div class="input-group">
                <input type="text" class="form-control" asp-for="AccessToken" id="accessTokenField" placeholder="Enter token to update..." value="@(Model.AuthSuccessToken ?? Model.AccessToken)" />
                <button type="button" class="btn btn-outline-primary" title="Authenticate with Home Assistant" onclick="authenticateWithHomeAssistant(event)">
                    <i class="fa-solid fa-key"></i> Fetch Token
                </button>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Dashboard Host</label>
            <input type="text" class="form-control" asp-for="Host" />
        </div>
        <div class="mb-3">
            <label class="form-label">Dashboard Path</label>
            <input type="text" class="form-control" asp-for="Path" />
        </div>
        <div class="mb-3">
            <label class="form-label">Update Times</label>
            <div class="d-flex align-items-center mb-2">
                <input type="time" id="updateTimeInput" class="form-control me-2" style="width: 150px;">
                <button type="button" class="btn btn-outline-primary" onclick="addUpdateTime()">Add</button>
            </div>
            <div id="updateTimesList" class="mb-2">
                <!-- Chips will be rendered here -->
            </div>
            <input type="hidden" name="UpdateTimesRaw" id="UpdateTimesRaw" value="@Model.UpdateTimesRaw" />
            <div class="form-text">Add one or more times. Example: 06:00, 12:00, 18:00</div>
        </div>
    </fieldset>
    <button type="submit" class="btn btn-primary">Save</button>
    <a asp-page="/Dashboards" class="btn btn-secondary ms-2">Cancel</a>
    <button type="button" class="btn btn-info ms-2" onclick="previewDashboard()">
        <i class="fa-solid fa-eye"></i> Preview
    </button>
</form>

<div id="copy-toast" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-4" role="alert" aria-live="assertive" aria-atomic="true" style="display:none; z-index: 1080;">
    <div class="d-flex">
        <div class="toast-body">
            API Key copied to clipboard!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close" onclick="hideCopyToast()"></button>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="position-fixed top-0 start-0 w-100 h-100" style="display:none; background-color: rgba(0,0,0,0.5); z-index: 1050; overflow: hidden;">
    <div class="position-absolute top-50 start-50 translate-middle rounded" style="width: 90vw; height: 90vh; max-width: 900px; max-height: 600px; display: flex; flex-direction: column; background-color: var(--bs-body-bg); color: var(--bs-body-color); border: 1px solid var(--bs-border-color);">
        <!-- Modal Header -->
        <div class="d-flex justify-content-between align-items-center p-3" style="border-bottom: 1px solid var(--bs-border-color);">
            <h5 class="mb-0">Dashboard Preview</h5>
            <div class="preview-modal-header-btns">
                <button type="button" class="btn btn-sm me-2 preview-reload-btn" title="Reload Preview" onclick="previewDashboard()">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
                <button type="button" class="btn-close" aria-label="Close" onclick="closePreviewModal()"></button>
            </div>
        </div>
        <!-- Modal Body -->
        <div class="flex-grow-1 overflow-auto p-3" id="preview-container" style="display: flex; justify-content: center; align-items: flex-start; background-color: var(--bs-secondary-bg);">
            <img id="preview-image" style="max-width: 100%; height: auto; object-fit: contain;" />
        </div>
        <!-- Modal Footer -->
        <div id="preview-error" class="alert alert-danger mb-0" style="display:none;"></div>
    </div>
</div>

<style>
    #updateTimesList .badge {
        display: inline-flex;
        align-items: center;
        font-size: 1rem;
        padding: 0.5em 0.75em;
    }
    #updateTimesList .btn-close {
        margin-left: 0.25em;
        margin-right: 0;
        margin-top: 0;
        margin-bottom: 0;
        vertical-align: middle;
    }
    /* Modal header buttons */
    .preview-modal-header-btns {
        display: flex;
        align-items: center;
    }
    .preview-modal-header-btns .preview-reload-btn {
        border: 0;
        background: transparent;
        padding: 0.25rem 0.4rem;
        line-height: 1;
    }
    .preview-modal-header-btns .preview-reload-btn:focus {
        box-shadow: none;
    }
    
    /* API Key field readonly styling for dark mode */
    #apiKeyField:read-only {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
    }
    
    #apiKeyField:read-only:disabled {
        opacity: 1;
    }
</style>

<script>
    // Parse initial value
    let updateTimesRaw = '@(Model.UpdateTimesRaw ?? "")';
    let updateTimes = updateTimesRaw ? updateTimesRaw.split(',').filter(t => t) : [];
    function renderUpdateTimes() {
        const list = document.getElementById('updateTimesList');
        list.innerHTML = '';
        updateTimes.forEach((t, idx) => {
            const chip = document.createElement('span');
            chip.className = 'badge bg-primary me-1 mb-1';
            chip.textContent = t + ' ';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-close btn-close-white btn-sm ms-1';
            btn.onclick = () => { updateTimes.splice(idx, 1); renderUpdateTimes(); };
            chip.appendChild(btn);
            list.appendChild(chip);
        });
        document.getElementById('UpdateTimesRaw').value = updateTimes.join(',');
    }
    function addUpdateTime() {
        const input = document.getElementById('updateTimeInput');
        const val = input.value;
        if (val && !updateTimes.includes(val)) {
            updateTimes.push(val);
            updateTimes.sort();
            renderUpdateTimes();
        }
        input.value = '';
    }
    function copyApiKey(apiKey) {
        navigator.clipboard.writeText(apiKey).then(function() {
            showCopyToast();
        });
    }
    function showCopyToast() {
        var toast = document.getElementById('copy-toast');
        toast.style.display = 'block';
        setTimeout(hideCopyToast, 2000);
    }
    function hideCopyToast() {
        var toast = document.getElementById('copy-toast');
        toast.style.display = 'none';
    }
    
    async function authenticateWithHomeAssistant(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const hostField = document.querySelector('input[name="Host"]');
        const dashboardIdField = document.querySelector('input[name="Id"]');
        const nameField = document.querySelector('input[name="Name"]');
        const form = document.querySelector('form');
        const host = hostField?.value?.trim();
        const dashboardId = dashboardIdField?.value;
        const name = nameField?.value?.trim();
        
        if (!host) {
            // Highlight the host field
            hostField?.classList.add('is-invalid');
            hostField?.focus();
            
            // Show error feedback
            let feedback = hostField?.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                hostField?.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Please enter Dashboard Host before authenticating';
            
            // Remove highlight after user starts typing
            const removeHighlight = () => {
                hostField?.classList.remove('is-invalid');
                feedback?.remove();
                hostField?.removeEventListener('input', removeHighlight);
            };
            hostField?.addEventListener('input', removeHighlight);
            return;
        }
        
        if (!name) {
            alert('Please enter a Dashboard Name before authenticating');
            nameField?.focus();
            return;
        }
        
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        
        try {
            // Show saving state
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            // Save the dashboard first
            const formData = new FormData(form);
            const saveResponse = await fetch(window.location.pathname, {
                method: 'POST',
                body: formData
            });
            
            if (!saveResponse.ok) {
                throw new Error('Failed to save dashboard');
            }
            
            // Show auth starting state
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting auth...';
            
            // Start the OAuth2 flow
            const response = await fetch('/api/homeassistant/start-auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ host: host, dashboardId: dashboardId })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP Error ${response.status}`);
            }
            
            const data = await response.json();
            
            // Redirect to Home Assistant for authorization
            window.location.href = data.authUrl;
            
        } catch (error) {
            console.error('Authentication error:', error);
            alert('Authentication failed: ' + error.message);
            // Restore button state
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
    }
    
    // Track created object URL so we can revoke it when closing/resetting
    let _previewObjectUrl = null;
    // Track preview attempts to ignore stale load/error handlers
    let _previewAttempt = 0;

    async function previewDashboard() {
        const attempt = ++_previewAttempt;
        const modal = document.getElementById('preview-modal');
        const errorDiv = document.getElementById('preview-error');
        const container = document.getElementById('preview-container');
        const imageElement = document.getElementById('preview-image');

        // Clear previous error and image
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        if (_previewObjectUrl) {
            try { 
                URL.revokeObjectURL(_previewObjectUrl); 
            } catch (e) 
            { }
            _previewObjectUrl = null;
        }
        imageElement.src = '';

        // Show loading state and ensure modal is visible
        modal.style.display = 'block';
        modal.style.zIndex = 2000;
        container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

        try {
            const dashboardIdInput = document.querySelector('input[name="Id"]');
            const dashboardId = dashboardIdInput ? dashboardIdInput.value : null;
            const apiKey = document.querySelector('form').dataset.apiKey || '';
            if (!dashboardId) {
                throw new Error('Dashboard ID not found');
            }
            if (!apiKey) {
                throw new Error('API Key not found');
            }

            // Call the existing API controller endpoint to get the original image
            const url = `/api/render/original?width=800&height=480&format=png`;
            const response = await fetch(url, { headers: { 'X-Api-Key': apiKey } });

            if (!response.ok) {
                let errorMessage = `HTTP Error ${response.status}: Failed to render preview`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (e) {
                    // If response body is not JSON, use HTTP error message
                }
                throw new Error(errorMessage);
            }

            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            _previewObjectUrl = imageUrl;

            // Update container with a fresh image element (so load/error events work reliably)
            container.innerHTML = '';
            const img = document.createElement('img');
            img.id = 'preview-image';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'contain';
            img.alt = 'Dashboard preview';
            img.onload = function() {
                if (attempt !== _previewAttempt) return;
                // image loaded, clear any errors
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            };
            img.onerror = function() {
                if (attempt !== _previewAttempt) return;
                // show error if image cannot be decoded
                errorDiv.textContent = 'Error: failed to load image data';
                errorDiv.style.display = 'block';
            };
            img.src = imageUrl;
            container.appendChild(img);
        } catch (error) {
            // Ensure modal stays visible and show the error
            modal.style.display = 'block';
            container.innerHTML = '';
            if (attempt === _previewAttempt) {
                errorDiv.textContent = 'Error: ' + (error && error.message ? error.message : String(error));
                errorDiv.style.display = 'block';
            }
            // Move focus to modal for accessibility / visibility
            try { document.getElementById('preview-modal').focus(); } catch (e) { }
        }
    }
    
    function closePreviewModal() {
        const modal = document.getElementById('preview-modal');
        const container = document.getElementById('preview-container');
        const errorDiv = document.getElementById('preview-error');
        const img = document.getElementById('preview-image');

        // Hide modal
        modal.style.display = 'none';

        // Revoke any object URL and clear image src
        try {
            if (typeof _previewObjectUrl === 'string' && _previewObjectUrl) {
                URL.revokeObjectURL(_previewObjectUrl);
            }
        } catch (e) { }
        _previewObjectUrl = null;
        if (img) { img.src = ''; }

        // Reset container to default state (image element present)
        container.innerHTML = '<img id="preview-image" style="max-width: 100%; height: auto; object-fit: contain;" />';

        // Hide error
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
    }
    
    // Close modal when clicking outside of it
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('preview-modal');
        if (event.target === modal) {
            closePreviewModal();
        }
    });
    
    document.addEventListener('DOMContentLoaded', renderUpdateTimes);
</script>
