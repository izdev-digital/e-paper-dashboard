@page "{id}"
@model EPaperDashboard.Pages.Dashboards.EditModel
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@{
    ViewData["Title"] = "Edit Dashboard";
}

<h2>Edit Dashboard</h2>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<form method="post">
    <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" class="form-control" asp-for="Name" required />
    </div>
    <div class="mb-3">
        <label class="form-label">Description</label>
        <input type="text" class="form-control" asp-for="Description" />
    </div>
    <div class="mb-3">
        <label class="form-label">API Key</label>
        <input type="text" class="form-control" asp-for="ApiKey" readonly tabindex="-1" style="background-color: #e9ecef; pointer-events: none;" />
    </div>
    <div class="mb-3">
        <label class="form-label">Access Token</label>
        <input type="text" class="form-control" asp-for="AccessToken" />
    </div>
    <div class="mb-3">
        <label class="form-label">Dashboard Host</label>
        <input type="text" class="form-control" asp-for="Host" />
    </div>
    <div class="mb-3">
        <label class="form-label">Dashboard Path</label>
        <input type="text" class="form-control" asp-for="Path" />
    </div>
    <div class="mb-3">
        <label class="form-label">Update Times</label>
        <div class="d-flex align-items-center mb-2">
            <input type="time" id="updateTimeInput" class="form-control me-2" style="width: 150px;">
            <button type="button" class="btn btn-outline-primary" onclick="addUpdateTime()">Add</button>
        </div>
        <div id="updateTimesList" class="mb-2">
            <!-- Chips will be rendered here -->
        </div>
        <input type="hidden" name="UpdateTimesRaw" id="UpdateTimesRaw" value="@Model.UpdateTimesRaw" />
        <div class="form-text">Add one or more times. Example: 06:00, 12:00, 18:00</div>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    <a asp-page="/Dashboards" class="btn btn-secondary ms-2">Cancel</a>
</form>

<style>
    #updateTimesList .badge {
        display: inline-flex;
        align-items: center;
        font-size: 1rem;
        padding: 0.5em 0.75em;
    }
    #updateTimesList .btn-close {
        margin-left: 0.25em;
        margin-right: 0;
        margin-top: 0;
        margin-bottom: 0;
        vertical-align: middle;
    }
</style>

<script>
    // Parse initial value
    let updateTimesRaw = '@(Model.UpdateTimesRaw ?? "")';
    let updateTimes = updateTimesRaw ? updateTimesRaw.split(',').filter(t => t) : [];
    function renderUpdateTimes() {
        const list = document.getElementById('updateTimesList');
        list.innerHTML = '';
        updateTimes.forEach((t, idx) => {
            const chip = document.createElement('span');
            chip.className = 'badge bg-primary me-1 mb-1';
            chip.textContent = t + ' ';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-close btn-close-white btn-sm ms-1';
            btn.onclick = () => { updateTimes.splice(idx, 1); renderUpdateTimes(); };
            chip.appendChild(btn);
            list.appendChild(chip);
        });
        document.getElementById('UpdateTimesRaw').value = updateTimes.join(',');
    }
    function addUpdateTime() {
        const input = document.getElementById('updateTimeInput');
        const val = input.value;
        if (val && !updateTimes.includes(val)) {
            updateTimes.push(val);
            updateTimes.sort();
            renderUpdateTimes();
        }
        input.value = '';
    }
    document.addEventListener('DOMContentLoaded', renderUpdateTimes);
</script>
