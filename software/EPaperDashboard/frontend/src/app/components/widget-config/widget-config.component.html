<!-- Debug logs removed -->
<!-- Universal Entity Selection Dropdown -->
@if (entities().length > 0 && widget.config && 'entityId' in widget.config) {
  <div class="mb-3">
    <label class="form-label">Data Source Entity</label>
    <select class="form-select" [(ngModel)]="widget.config.entityId">
      <option value="">Select entity...</option>
      @for (entity of getFilteredEntities(); track trackByEntityId($index, entity)) {
        <option [value]="entity.entity_id">{{ entity.friendly_name || entity.entity_id }}</option>
      }
    </select>
  </div>
}
@switch (widget.type) {

  @case ('header') {
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" class="form-control" [(ngModel)]="headerConfig.title" placeholder="Enter title" />
    </div>
    <div class="mb-3">
      <label class="form-label">Title Position</label>
      <select class="form-select" [(ngModel)]="headerConfig.titleAlign">
        <option [ngValue]="'top-left'">Top Left (Default)</option>
        <option [ngValue]="'top-right'">Top Right</option>
        <option [ngValue]="'bottom-left'">Bottom Left</option>
        <option [ngValue]="'bottom-right'">Bottom Right</option>
      </select>
      <small class="form-text text-muted">Badges will wrap around the title and fill remaining space.</small>
    </div>
    <div class="mb-3">
      <label class="form-label">App Icon</label>
      <input type="text" class="form-control" [(ngModel)]="headerConfig.iconUrl" placeholder="/icon.svg (default)" />
      <small class="form-text text-muted">Leave blank to use the default app icon (icon.svg).</small>
    </div>
    <div class="mb-3">
      <label class="form-label">Icon Size (px)</label>
      <input type="number" class="form-control" [(ngModel)]="headerConfig.iconSize" min="16" max="128" placeholder="32" />
    </div>
    <div class="mb-3">
      <label class="form-label">Badges</label>
      <small class="form-text text-muted d-block mb-2">Badges automatically adjust to widget size. Only visible badges that fit will be shown.</small>
      @if (headerConfig.badges?.length) {
        <div>
          @for (badge of headerConfig.badges; track trackByBadgeLabel($index, badge); let i = $index) {
            <div class="badge-item mb-2">
              <div class="d-flex gap-2 align-items-center">
                <input type="text" class="form-control form-control-sm" placeholder="Icon (e.g., fa-thermometer)" [(ngModel)]="badge.icon" />
                <select class="form-select form-select-sm" [(ngModel)]="badge.entityId">
                  <option [ngValue]="undefined">No Entity</option>
                  @for (entity of entities(); track trackByEntityId($index, entity)) {
                    <option [ngValue]="entity.entity_id">{{ entity.friendly_name || entity.entity_id }}</option>
                  }
                </select>
                <button class="btn btn-sm btn-danger" (click)="removeBadge(i)"><i class="fa fa-trash"></i></button>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="text-muted small mb-2">No badges configured.</div>
      }
      <button class="btn btn-sm btn-outline-primary w-100" (click)="addBadge()"><i class="fa fa-plus"></i> Add Badge</button>
    </div>
  }

  @case ('markdown') {
            <div class="mb-3">
              <label class="form-label">Content</label>
              <textarea class="form-control" rows="6" [(ngModel)]="markdownConfig.content"
                placeholder="# Markdown content here"></textarea>
            </div>

          }

    @case ('calendar') {
              <div class="mb-3">
                <label class="form-label">Calendar Entity</label>
                <select class="form-select" [(ngModel)]="calendarConfig.entityId">
                  <option value="">Select entity...</option>
                  @for (entity of entities(); track trackByEntityId($index, entity)) {
                    <option [value]="entity.entity_id">{{ entity.friendly_name || entity.entity_id }}</option>
                  }
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Max Events</label>
                <input type="number" class="form-control" [(ngModel)]="calendarConfig.maxEvents" min="1" max="20" />
              </div>

            }

  @case ('weather') {
                <div class="mb-3">
                  <label class="form-label">Weather Entity</label>
                  <select class="form-select" [(ngModel)]="weatherConfig.entityId">
                    <option value="">Select entity...</option>
                    @for (entity of entities(); track trackByEntityId($index, entity)) {
                      <option [value]="entity.entity_id">{{ entity.friendly_name || entity.entity_id }}</option>
                    }
                  </select>
                </div>
              }

    @case ('weather-forecast') {
                <div class="mb-3">
                  <label class="form-label">Weather Entity</label>
                  <select class="form-select" [(ngModel)]="weatherForecastConfig.entityId">
                    <option value="">Select entity...</option>
                    @for (entity of entities(); track trackByEntityId($index, entity)) {
                      <option [value]="entity.entity_id">{{ entity.friendly_name || entity.entity_id }}</option>
                    }
                  </select>
                </div>
            }

  @case ('graph') {
                <div class="mb-3">
                  <label class="form-label">Sensor Entity</label>
                  <select class="form-select" [(ngModel)]="graphConfig.entityId">
                    <option value="">Select entity...</option>
                    @for (entity of entities(); track trackByEntityId($index, entity)) {
                      <option [value]="entity.entity_id">{{ entity.friendly_name || entity.entity_id }}</option>
                    }
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Period</label>
                  <select class="form-select" [(ngModel)]="graphConfig.period">
                    <option value="1h">1 Hour</option>
                    <option value="6h">6 Hours</option>
                    <option value="24h">24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Label (optional)</label>
                  <input type="text" class="form-control" [(ngModel)]="graphConfig.label" />
                </div>
            }

  @case ('todo') {
                <!-- Todo widget uses the universal entity selector above -->
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="todoConfig.showCompleted" id="showCompleted">
                    <label class="form-check-label" for="showCompleted">
                      Show completed items
                    </label>
                  </div>
                </div>
            }

  @case ('display') {
    @if (widget.config && 'text' in widget.config) {
                  <div class="mb-3">
                    <label class="form-label">Text</label>
                    <input type="text" class="form-control" [(ngModel)]="widget.config.text" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Color</label>
                    <input type="color" class="form-control form-control-color" [(ngModel)]="widget.config.color" />
                  </div>
    }
  }

  @case ('app-icon') {
                  <div class="mb-3">
                    <label class="form-label">Icon URL (optional)</label>
                    <input type="text" class="form-control" [(ngModel)]="appIconConfig.iconUrl"
                      placeholder="Leave blank for default app icon" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Size (px)</label>
                    <input type="number" class="form-control" [(ngModel)]="appIconConfig.size" min="16" max="256" />
                  </div>
  }

  @case ('image') {
    @if (widget.config && 'imageUrl' in widget.config) {
                  <div class="mb-3">
                    <label class="form-label">Image URL</label>
                    <input type="text" class="form-control" [(ngModel)]="widget.config.imageUrl"
                      placeholder="https://... or /assets/..." />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Fit</label>
                    <select class="form-select" [(ngModel)]="widget.config.fit">
                      <option value="contain">Contain</option>
                      <option value="cover">Cover</option>
                      <option value="fill">Fill</option>
                    </select>
                  </div>
    }
  }

  @case ('version') {
    <div class="text-muted small">
      <i class="fa fa-info-circle"></i> This widget displays the software version. No configuration needed.
    </div>
  }
}