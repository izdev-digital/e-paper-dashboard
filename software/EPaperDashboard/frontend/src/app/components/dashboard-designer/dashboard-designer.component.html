<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard Designer - {{ dashboard()?.name }}</h2>
        <div>
          <button class="btn btn-secondary me-2" (click)="goBack()">
            <i class="fa fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-primary" (click)="saveDashboard()">
            <i class="fa fa-save"></i> Save Layout
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (!isLoading()) {
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-info mb-0">
          <i class="fa fa-info-circle"></i>
          <strong>How to use:</strong> Click widgets in the toolbar to add them. Select a widget on the canvas to edit its position, size, and properties in the right panel. Use arrow buttons or input fields to position widgets.
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Left Panel - Widget Toolbar -->
      <div class="col-md-2">
        <div class="card">
          <div class="card-header">
            <h5>Widgets</h5>
          </div>
          <div class="card-body p-2">
            <div class="widget-list">
              @for (widget of availableWidgets; track widget.type) {
                <button
                  class="btn btn-outline-primary w-100 mb-2"
                  (click)="addWidget(widget.type)"
                >
                  <i class="fa {{ widget.icon }}"></i>
                  {{ widget.label }}
                </button>
              }
            </div>
          </div>
        </div>

        <!-- Color Scheme Selector -->
        <div class="card mt-3">
          <div class="card-header">
            <h5>Color Scheme</h5>
          </div>
          <div class="card-body p-2">
            <select
              class="form-select"
              [ngModel]="layout().colorScheme"
              (ngModelChange)="updateColorScheme($event)"
            >
              @for (scheme of colorSchemes; track scheme.name) {
                <option [ngValue]="scheme">
                  {{ scheme.name }}
                </option>
              }
            </select>
          </div>
        </div>

        <!-- Layout Settings -->
        <div class="card mt-3">
          <div class="card-header">
            <h5>Layout</h5>
          </div>
          <div class="card-body p-2">
            <div class="mb-2">
              <label class="form-label small">Width</label>
              <input type="number" class="form-control form-control-sm" [ngModel]="layout().width" (ngModelChange)="updateLayoutWidth($event)" />
            </div>
            <div class="mb-2">
              <label class="form-label small">Height</label>
              <input type="number" class="form-control form-control-sm" [ngModel]="layout().height" (ngModelChange)="updateLayoutHeight($event)" />
            </div>
            <div class="mb-2">
              <label class="form-label small">Grid Columns</label>
              <input type="number" class="form-control form-control-sm" [ngModel]="layout().gridCols" (ngModelChange)="updateLayoutGridCols($event)" />
            </div>
            <div class="mb-2">
              <label class="form-label small">Grid Rows</label>
              <input type="number" class="form-control form-control-sm" [ngModel]="layout().gridRows" (ngModelChange)="updateLayoutGridRows($event)" />
            </div>
          </div>
        </div>
      </div>

      <!-- Center - Canvas -->
      <div class="col-md-7">
        <div class="card">
          <div class="card-header">
            <h5>Canvas</h5>
          </div>
          <div class="card-body" style="overflow: auto;">
            <div class="canvas-wrapper d-flex justify-content-center">
              <div class="dashboard-canvas" [ngStyle]="getGridStyle()">
                @for (widget of layout().widgets; track widget.id) {
                  <div
                    class="widget-container"
                    [ngStyle]="getWidgetStyle(widget)"
                    [class.selected]="selectedWidget()?.id === widget.id"
                    (mousedown)="onWidgetMouseDown($event, widget)"
                  >
                    <div class="widget-header">
                      <span class="widget-type">{{ widget.type }}</span>
                      <button
                        class="btn btn-sm btn-danger delete-btn"
                        (click)="deleteWidget(widget); $event.stopPropagation()"
                      >
                        <i class="fa fa-trash"></i>
                      </button>
                    </div>
                    <div class="widget-content">
                      <app-widget-preview [widget]="widget" [colorScheme]="layout().colorScheme"></app-widget-preview>
                    </div>
                    
                    <!-- Resize Handles -->
                    @if (selectedWidget()?.id === widget.id) {
                      <div class="resize-handle resize-e" data-direction="e"></div>
                      <div class="resize-handle resize-s" data-direction="s"></div>
                      <div class="resize-handle resize-se" data-direction="se"></div>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Widget Properties -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header">
            <h5>Properties</h5>
          </div>
          <div class="card-body">
            @if (!selectedWidget()) {
              <div class="text-muted text-center py-4">
                Select a widget to edit its properties
              </div>
            }

            @if (selectedWidget()) {
              <h6>{{ selectedWidget()!.type | titlecase }}</h6>
              <hr />

              <!-- Position Settings -->
              <div class="mb-3">
                <label class="form-label small">Position & Size</label>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small">X</label>
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      [ngModel]="selectedWidget()!.position.x"
                      (ngModelChange)="updateWidgetPosition(selectedWidget()!, { x: $event })"
                      min="0"
                      [max]="layout().gridCols - 1"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Y</label>
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      [ngModel]="selectedWidget()!.position.y"
                      (ngModelChange)="updateWidgetPosition(selectedWidget()!, { y: $event })"
                      min="0"
                      [max]="layout().gridRows - 1"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Width</label>
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      [ngModel]="selectedWidget()!.position.w"
                      (ngModelChange)="updateWidgetPosition(selectedWidget()!, { w: $event })"
                      min="1"
                      [max]="layout().gridCols"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Height</label>
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      [ngModel]="selectedWidget()!.position.h"
                      (ngModelChange)="updateWidgetPosition(selectedWidget()!, { h: $event })"
                      min="1"
                      [max]="layout().gridRows"
                    />
                  </div>
                </div>
              </div>

              <!-- Widget-Specific Config -->
              <app-widget-config
                [widget]="selectedWidget()!"
                [dashboard]="dashboard()"
              ></app-widget-config>

              <!-- Quick Move Controls -->
              <div class="mt-3">
                <label class="form-label small">Quick Move</label>
                <div class="btn-group w-100 mb-2" role="group">
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveWidget(selectedWidget()!, -1, 0)" title="Move Left">
                    <i class="fa fa-arrow-left"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveWidget(selectedWidget()!, 0, -1)" title="Move Up">
                    <i class="fa fa-arrow-up"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveWidget(selectedWidget()!, 0, 1)" title="Move Down">
                    <i class="fa fa-arrow-down"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveWidget(selectedWidget()!, 1, 0)" title="Move Right">
                    <i class="fa fa-arrow-right"></i>
                  </button>
                </div>
                <label class="form-label small">Quick Resize</label>
                <div class="btn-group w-100" role="group">
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="resizeWidget(selectedWidget()!, -1, 0)" title="Narrower">
                    <i class="fa fa-compress-arrows-alt"></i> W-
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="resizeWidget(selectedWidget()!, 1, 0)" title="Wider">
                    <i class="fa fa-expand-arrows-alt"></i> W+
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="resizeWidget(selectedWidget()!, 0, -1)" title="Shorter">
                    <i class="fa fa-compress-arrows-alt"></i> H-
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="resizeWidget(selectedWidget()!, 0, 1)" title="Taller">
                    <i class="fa fa-expand-arrows-alt"></i> H+
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }

  @if (isLoading()) {
    <div class="text-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
</div>
