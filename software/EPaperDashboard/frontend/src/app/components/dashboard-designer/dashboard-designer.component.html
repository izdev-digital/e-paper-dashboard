<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard Designer - {{ dashboard()?.name }}</h2>
        <div>
          <button class="btn btn-secondary me-2" (click)="goBack()">
            <i class="fa fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-primary" (click)="saveDashboard()">
            <i class="fa fa-save"></i> Save Layout
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (isLoading()) {
    <div class="row">
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading dashboard...</p>
      </div>
    </div>
  }

  @if (!isLoading()) {
    <div class="row">
      <!-- Left Panel - Widget Toolbar -->
      <div class="col-md-2">
        <div class="card">
          <div class="card-header">
            <h5>Widgets</h5>
          </div>
          <div class="card-body p-2">
            <div class="widget-list">
              @for (widget of availableWidgets; track widget.type) {
                <div
                  class="btn btn-outline-primary w-100 mb-2 toolbox-drag-item"
                  (mousedown)="onToolboxWidgetMouseDown($event, widget)"
                  tabindex="0"
                  title="Drag to canvas"
                >
                  <i class="fa {{ widget.icon }}"></i>
                  {{ widget.label }}
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Center - Canvas -->
      <div class="col-md-7">
        <div class="card">
          <div class="card-header">
            <h5>Canvas</h5>
          </div>
          <div class="card-body" style="overflow: auto;">
            <div class="canvas-wrapper">
              <div class="dashboard-canvas" [ngStyle]="getCanvasStyle()">
                @for (widget of layout().widgets; track widget.id) {
                  <div
                    class="widget-container"
                    [ngStyle]="getWidgetStyle(widget)"
                    [class.selected]="selectedWidget()?.id === widget.id"
                    (mousedown)="onWidgetMouseDown($event, widget)"
                  >
                    <div class="widget-header">
                      <span class="widget-type">{{ widget.type }}</span>
                      <button
                        class="btn btn-sm btn-danger delete-btn"
                        (click)="deleteWidget(widget); $event.stopPropagation()"
                      >
                        <i class="fa fa-trash"></i>
                      </button>
                    </div>
                    <div class="widget-content">
                      <app-widget-preview [widget]="widget" [colorScheme]="layout().colorScheme" [entityStates]="entityStates()"></app-widget-preview>
                    </div>
                    <!-- Resize Handles -->
                    @if (selectedWidget()?.id === widget.id) {
                      <div class="resize-handle resize-e" data-direction="e"></div>
                      <div class="resize-handle resize-s" data-direction="s"></div>
                      <div class="resize-handle resize-se" data-direction="se"></div>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Widget Properties -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header">
            <div class="custom-tab-bar-scroll">
              <button class="tab-switch-btn left" (click)="switchTab('left')" type="button" aria-label="Previous tab">
                <i class="fa fa-chevron-left"></i>
              </button>
              <div class="custom-tab-bar" #tabBar>
                <button class="tab-btn" [class.active]="activeTab() === 'dashboard'" (click)="activeTab.set('dashboard')">Dashboard Settings</button>
                <button class="tab-btn" [class.active]="activeTab() === 'widgets'" (click)="activeTab.set('widgets')">Widgets ({{ layout().widgets.length }})</button>
                <button class="tab-btn" [class.active]="activeTab() === 'properties'" (click)="activeTab.set('properties')">Widget Properties</button>
              </div>
              <button class="tab-switch-btn right" (click)="switchTab('right')" type="button" aria-label="Next tab">
                <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            @if (activeTab() === 'dashboard') {
              <!-- Color Scheme Selector -->
              <div class="card mb-3">
                <div class="card-header">
                  <h5>Color Scheme</h5>
                </div>
                <div class="card-body p-2">
                  <select
                    class="form-select"
                    [ngModel]="layout().colorScheme"
                    (ngModelChange)="updateColorScheme($event)"
                  >
                    @for (scheme of colorSchemes; track scheme.name) {
                      <option [ngValue]="scheme">
                        {{ scheme.name }}
                      </option>
                    }
                  </select>
                </div>
              </div>
              <!-- Layout Settings -->
              <div class="card">
                <div class="card-header">
                  <h5>Layout</h5>
                </div>
                <div class="card-body p-2">
                  <div class="mb-2">
                    <label class="form-label small">Width</label>
                    <input type="number" class="form-control form-control-sm" [ngModel]="layout().width" (ngModelChange)="updateLayoutWidth($event)" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Height</label>
                    <input type="number" class="form-control form-control-sm" [ngModel]="layout().height" (ngModelChange)="updateLayoutHeight($event)" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Grid Columns</label>
                    <input type="number" class="form-control form-control-sm" [ngModel]="layout().gridCols" (ngModelChange)="updateLayoutGridCols($event)" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Grid Rows</label>
                    <input type="number" class="form-control form-control-sm" [ngModel]="layout().gridRows" (ngModelChange)="updateLayoutGridRows($event)" />
                  </div>
                </div>
              </div>
            }

            @if (activeTab() === 'properties') {
              @if (!selectedWidget()) {
                <div class="text-muted text-center py-4">
                  Select a widget to edit its properties
                </div>
              }

              @if (selectedWidget()) {
                <h6>{{ selectedWidget()!.type | titlecase }}</h6>
                <hr />

                <!-- Position Settings -->
                <div class="mb-3">
                  <label class="form-label small">Position & Size</label>
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label small">X</label>
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        [ngModel]="selectedWidget()!.position.x"
                        (ngModelChange)="updateWidgetPosition(selectedWidget()!, { x: $event })"
                        min="0"
                        [max]="layout().gridCols - 1"
                      />
                    </div>
                    <div class="col-6">
                      <label class="form-label small">Y</label>
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        [ngModel]="selectedWidget()!.position.y"
                        (ngModelChange)="updateWidgetPosition(selectedWidget()!, { y: $event })"
                        min="0"
                        [max]="layout().gridRows - 1"
                      />
                    </div>
                    <div class="col-6">
                      <label class="form-label small">Width</label>
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        [ngModel]="selectedWidget()!.position.w"
                        (ngModelChange)="updateWidgetPosition(selectedWidget()!, { w: $event })"
                        min="1"
                        [max]="layout().gridCols"
                      />
                    </div>
                    <div class="col-6">
                      <label class="form-label small">Height</label>
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        [ngModel]="selectedWidget()!.position.h"
                        (ngModelChange)="updateWidgetPosition(selectedWidget()!, { h: $event })"
                        min="1"
                        [max]="layout().gridRows"
                      />
                    </div>
                  </div>
                </div>

                <!-- Widget-Specific Config -->
                <app-widget-config
                  [widget]="selectedWidget()!"
                  [dashboard]="dashboard()"
                ></app-widget-config>
              }
            }

            @if (activeTab() === 'widgets') {
              @if (layout().widgets.length === 0) {
                <div class="text-muted text-center py-4">
                  <p>No widgets added yet.</p>
                  <small>Drag widgets from the toolbar or click to add them.</small>
                </div>
              }
              @if (layout().widgets.length > 0) {
                <div class="widgets-list">
                  @for (w of layout().widgets; track w.id) {
                    <div
                      class="widget-item mb-2 p-2 border rounded"
                      [class.active]="selectedWidget()?.id === w.id"
                      (click)="selectWidget(w); activeTab.set('properties')"
                    >
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <div class="fw-bold">{{ w.type | titlecase }}</div>
                          <small class="text-muted">ID: {{ w.id }}</small>
                          <div class="small mt-1">
                            <span class="badge bg-secondary">{{ w.position.x }},{{ w.position.y }}</span>
                            <span class="badge bg-secondary">{{ w.position.w }}Ã—{{ w.position.h }}</span>
                          </div>
                        </div>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="deleteWidget(w); $event.stopPropagation()"
                          title="Delete widget"
                        >
                          <i class="fa fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            }
          </div>
        </div>
      </div>
    </div>
  }

  @if (isLoading()) {
    <div class="text-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
</div>
