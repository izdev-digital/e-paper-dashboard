<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard Designer - {{ dashboard()?.name }}</h2>
        <div> <button class="btn btn-info me-2" (click)="refreshLivePreview()" [disabled]="livePreviewLoading()">
            @if (livePreviewLoading()) {
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            } @else {
            <i class="fa fa-sync"></i>
            }
            Refresh Preview Data
          </button> <button class="btn btn-secondary me-2" (click)="goBack()">
            <i class="fa fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-primary" (click)="saveDashboard()">
            <i class="fa fa-save"></i> Save Layout
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (isLoading()) {
  <div class="row">
    <div class="col-12 text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading dashboard...</p>
    </div>
  </div>
  }

  @if (!isLoading()) {
  <div class="designer-grid-container">
    <!-- Left Panel - Widget Toolbar -->
    <div class="designer-panel-left">
      <div class="card">
        <div class="card-header">
          <h5>Widgets</h5>
        </div>
        <div class="card-body p-2">
          <div class="widget-list">
            @for (widget of availableWidgets; track widget.type) {
            <div class="widget-item toolbox-drag-item" (mousedown)="onToolboxWidgetMouseDown($event, widget)"
              tabindex="0" title="Drag to canvas">
              <i class="fa {{ widget.icon }}"></i>
              <span>{{ widget.label }}</span>
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Center - Canvas -->
    <div class="designer-panel-center">
      <div class="card">
        <div class="card-header">
          <h5>Canvas</h5>
        </div>
        <div class="card-body" style="overflow: auto;">
          <div class="canvas-wrapper">
            <div class="dashboard-canvas" [ngStyle]="getCanvasStyle()">
              <div class="grid-overlay" [ngStyle]="getGridOverlayStyle()"></div>
              @for (widget of layout().widgets; track widget.id) {
              <div class="widget-container" [ngStyle]="getWidgetStyle(widget)"
                [class.selected]="selectedWidget()?.id === widget.id" (mousedown)="onWidgetMouseDown($event, widget)">
                <!-- Widget header removed: no name, no delete button -->
                <div class="widget-content">
                  <app-widget-preview [widget]="widget" [colorScheme]="layout().colorScheme"
                    [entityStates]="entityStates()" [todoItemsByEntityId]="todoItemsByEntityId()"
                    [calendarEventsByEntityId]="calendarEventsByEntityId()"
                    [dashboardId]="dashboardId"
                    [designerSettings]="layout()"></app-widget-preview>
                </div>
                <!-- Resize Handles -->
                @if (selectedWidget()?.id === widget.id) {
                <div class="resize-handle resize-n" data-direction="n"></div>
                <div class="resize-handle resize-e" data-direction="e"></div>
                <div class="resize-handle resize-s" data-direction="s"></div>
                <div class="resize-handle resize-w" data-direction="w"></div>
                <div class="resize-handle resize-nw" data-direction="nw"></div>
                <div class="resize-handle resize-ne" data-direction="ne"></div>
                <div class="resize-handle resize-sw" data-direction="sw"></div>
                <div class="resize-handle resize-se" data-direction="se"></div>
                }
              </div>
              }
              @if (ghost()) {
              <div class="widget-ghost" [ngStyle]="getGhostStyle(ghost()!)"></div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Widget Properties -->
    <div class="designer-panel-right">
      <div class="card">
        <div class="card-header">
          <div class="custom-tab-bar-scroll">
            <button class="tab-switch-btn left" (click)="switchTab('left')" type="button" aria-label="Previous tab">
              <i class="fa fa-chevron-left"></i>
            </button>
            <div class="custom-tab-bar" #tabBar>
              <button class="tab-btn" [class.active]="activeTab() === 'dashboard'"
                (click)="activeTab.set('dashboard')">Dashboard Settings</button>
              <button class="tab-btn" [class.active]="activeTab() === 'widgets'"
                (click)="activeTab.set('widgets')">Widgets ({{ layout().widgets.length }})</button>
              <button class="tab-btn" [class.active]="activeTab() === 'properties'"
                (click)="activeTab.set('properties')">Widget Properties</button>
            </div>
            <button class="tab-switch-btn right" (click)="switchTab('right')" type="button" aria-label="Next tab">
              <i class="fa fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Dashboard Settings Tab -->
          <div class="tab-pane" [class.active]="activeTab() === 'dashboard'">
            <div class="card mb-3">
              <div class="card-header">
                <h5>Color Scheme</h5>
              </div>
              <div class="card-body p-2">
                <select class="form-select" [ngModel]="layout().colorScheme"
                  (ngModelChange)="updateColorScheme($event)">
                  @for (scheme of colorSchemes; track scheme.name) {
                  <option [ngValue]="scheme">
                    {{ scheme.name }}
                  </option>
                  }
                </select>
              </div>
            </div>
            <div class="card mb-3">
              <div class="card-header">
                <h5>Color Overrides</h5>
                <small class="text-muted d-block">Customize colors (limited to scheme palette)</small>
              </div>
              <div class="card-body p-2">
                <div class="mb-2">
                  <label class="form-label small">Canvas Background</label>
                  <select class="form-select form-select-sm" [ngModel]="layout().colorScheme.canvasBackgroundColor"
                    (ngModelChange)="updateCanvasBackgroundColor($event)">
                    @for (color of layout().colorScheme.palette; track color) {
                    <option [value]="color">
                      <span [style.backgroundColor]="color">{{ getColorName(color) }}</span>
                    </option>
                    }
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Background</label>
                  <select class="form-select form-select-sm" [ngModel]="layout().colorScheme.widgetBackgroundColor"
                    (ngModelChange)="updateWidgetBackgroundColor($event)">
                    @for (color of layout().colorScheme.palette; track color) {
                    <option [value]="color">{{ getColorName(color) }}</option>
                    }
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Border Color</label>
                  <select class="form-select form-select-sm" [ngModel]="layout().colorScheme.widgetBorderColor"
                    (ngModelChange)="updateWidgetBorderColor($event)">
                    @for (color of layout().colorScheme.palette; track color) {
                    <option [value]="color">{{ getColorName(color) }}</option>
                    }
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Title Text Color</label>
                  <select class="form-select form-select-sm" [ngModel]="layout().colorScheme.widgetTitleTextColor"
                    (ngModelChange)="updateWidgetTitleTextColor($event)">
                    @for (color of layout().colorScheme.palette; track color) {
                    <option [value]="color">{{ getColorName(color) }}</option>
                    }
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Text Color</label>
                  <select class="form-select form-select-sm" [ngModel]="layout().colorScheme.widgetTextColor"
                    (ngModelChange)="updateWidgetTextColor($event)">
                    @for (color of layout().colorScheme.palette; track color) {
                    <option [value]="color">{{ getColorName(color) }}</option>
                    }
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Icon Color</label>
                  <select class="form-select form-select-sm" [ngModel]="layout().colorScheme.iconColor"
                    (ngModelChange)="updateIconColor($event)">
                    @for (color of layout().colorScheme.palette; track color) {
                    <option [value]="color">{{ getColorName(color) }}</option>
                    }
                  </select>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h5>Layout</h5>
              </div>
              <div class="card-body p-2">
                <div class="mb-2">
                  <label class="form-label small">Width</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().width"
                    (ngModelChange)="updateLayoutWidth($event)" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Height</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().height"
                    (ngModelChange)="updateLayoutHeight($event)" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Grid Columns</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().gridCols"
                    (ngModelChange)="updateLayoutGridCols($event)" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Grid Rows</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().gridRows"
                    (ngModelChange)="updateLayoutGridRows($event)" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Canvas Padding</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().canvasPadding"
                    (ngModelChange)="updateCanvasPadding($event)" min="0" max="128" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Gap</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().widgetGap"
                    (ngModelChange)="updateWidgetGap($event)" min="0" max="64" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Border (px)</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().widgetBorder"
                    (ngModelChange)="updateWidgetBorder($event)" min="0" max="20" />
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h5>Font Sizes</h5>
              </div>
              <div class="card-body p-2">
                <div class="mb-2">
                  <label class="form-label small">Widget Title Font Size (px)</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().titleFontSize"
                    (ngModelChange)="updateTitleFontSize($event)" min="8" max="72" placeholder="16" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Text Font Size (px)</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="layout().textFontSize"
                    (ngModelChange)="updateTextFontSize($event)" min="6" max="48" placeholder="14" />
                </div>
              </div>
            </div>
          </div>

          <!-- Properties Tab -->
          <div class="tab-pane" [class.active]="activeTab() === 'properties'">
            @if (!selectedWidget()) {
            <div class="text-muted text-center py-4">
              Select a widget to edit its properties
            </div>
            }
            @if (selectedWidget()) {
            <h6>{{ selectedWidget()!.type | titlecase }}</h6>
            <hr />
            <div class="mb-3">
              <label class="form-label small">Position & Size</label>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">X</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="selectedWidget()!.position.x"
                    (ngModelChange)="updateWidgetPosition(selectedWidget()!, { x: $event })" min="0"
                    [max]="layout().gridCols - 1" />
                </div>
                <div class="col-6">
                  <label class="form-label small">Y</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="selectedWidget()!.position.y"
                    (ngModelChange)="updateWidgetPosition(selectedWidget()!, { y: $event })" min="0"
                    [max]="layout().gridRows - 1" />
                </div>
                <div class="col-6">
                  <label class="form-label small">Width</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="selectedWidget()!.position.w"
                    (ngModelChange)="updateWidgetPosition(selectedWidget()!, { w: $event })" min="1"
                    [max]="layout().gridCols" />
                </div>
                <div class="col-6">
                  <label class="form-label small">Height</label>
                  <input type="number" class="form-control form-control-sm" [ngModel]="selectedWidget()!.position.h"
                    (ngModelChange)="updateWidgetPosition(selectedWidget()!, { h: $event })" min="1"
                    [max]="layout().gridRows" />
                </div>
              </div>
            </div>
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">Color Overrides</h6>
                <small class="text-muted">Limited to scheme palette</small>
              </div>
              <div class="card-body p-2">
                <div class="mb-2">
                  <label class="form-label small">Widget Background Color</label>
                  <div class="input-group">
                    <select class="form-select form-select-sm"
                      [ngModel]="selectedWidget()!.colorOverrides?.widgetBackgroundColor || ''"
                      (ngModelChange)="updateWidgetColorOverride(selectedWidget()!, 'widgetBackgroundColor', $event)">
                      <option value="">Default ({{ layout().colorScheme.widgetBackgroundColor }})</option>
                      @for (color of layout().colorScheme.palette; track color) {
                      <option [value]="color">{{ getColorName(color) }}</option>
                      }
                    </select>
                    <button class="btn btn-sm btn-outline-secondary"
                      (click)="clearWidgetColorOverride(selectedWidget()!, 'widgetBackgroundColor')"
                      title="Clear override">×</button>
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Border Color</label>
                  <div class="input-group">
                    <select class="form-select form-select-sm"
                      [ngModel]="selectedWidget()!.colorOverrides?.widgetBorderColor || ''"
                      (ngModelChange)="updateWidgetColorOverride(selectedWidget()!, 'widgetBorderColor', $event)">
                      <option value="">Default ({{ layout().colorScheme.widgetBorderColor }})</option>
                      @for (color of layout().colorScheme.palette; track color) {
                      <option [value]="color">{{ getColorName(color) }}</option>
                      }
                    </select>
                    <button class="btn btn-sm btn-outline-secondary"
                      (click)="clearWidgetColorOverride(selectedWidget()!, 'widgetBorderColor')"
                      title="Clear override">×</button>
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Title Text Color</label>
                  <div class="input-group">
                    <select class="form-select form-select-sm"
                      [ngModel]="selectedWidget()!.colorOverrides?.widgetTitleTextColor || ''"
                      (ngModelChange)="updateWidgetColorOverride(selectedWidget()!, 'widgetTitleTextColor', $event)">
                      <option value="">Default ({{ layout().colorScheme.widgetTitleTextColor }})</option>
                      @for (color of layout().colorScheme.palette; track color) {
                      <option [value]="color">{{ getColorName(color) }}</option>
                      }
                    </select>
                    <button class="btn btn-sm btn-outline-secondary"
                      (click)="clearWidgetColorOverride(selectedWidget()!, 'widgetTitleTextColor')"
                      title="Clear override">×</button>
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Widget Text Color</label>
                  <div class="input-group">
                    <select class="form-select form-select-sm"
                      [ngModel]="selectedWidget()!.colorOverrides?.widgetTextColor || ''"
                      (ngModelChange)="updateWidgetColorOverride(selectedWidget()!, 'widgetTextColor', $event)">
                      <option value="">Default ({{ layout().colorScheme.widgetTextColor }})</option>
                      @for (color of layout().colorScheme.palette; track color) {
                      <option [value]="color">{{ getColorName(color) }}</option>
                      }
                    </select>
                    <button class="btn btn-sm btn-outline-secondary"
                      (click)="clearWidgetColorOverride(selectedWidget()!, 'widgetTextColor')"
                      title="Clear override">×</button>
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Icon Color</label>
                  <div class="input-group">
                    <select class="form-select form-select-sm"
                      [ngModel]="selectedWidget()!.colorOverrides?.iconColor || ''"
                      (ngModelChange)="updateWidgetColorOverride(selectedWidget()!, 'iconColor', $event)">
                      <option value="">Default ({{ layout().colorScheme.iconColor }})</option>
                      @for (color of layout().colorScheme.palette; track color) {
                      <option [value]="color">{{ getColorName(color) }}</option>
                      }
                    </select>
                    <button class="btn btn-sm btn-outline-secondary"
                      (click)="clearWidgetColorOverride(selectedWidget()!, 'iconColor')"
                      title="Clear override">×</button>
                  </div>
                </div>
              </div>
            </div>
            <app-widget-config [widget]="selectedWidget()!" [dashboard]="dashboard()"
              [availableEntities]="availableEntities()" [entitiesLoading]="entitiesLoading()"
              [colorScheme]="layout().colorScheme"
              [attr.key]="selectedWidget()!.id"></app-widget-config>
            }
          </div>

          <!-- Widgets List Tab -->
          <div class="widgets-list-pane" [class.active]="activeTab() === 'widgets'">
            @if (layout().widgets.length === 0) {
            <div class="text-muted text-center py-4">
              <p>No widgets added yet.</p>
              <small>Drag widgets from the toolbar or click to add them.</small>
            </div>
            } @else {
            @for (w of layout().widgets; track w.id) {
            <div class="widget-item p-2 border rounded" [class.active]="selectedWidget()?.id === w.id"
              (click)="onWidgetSelect(w)">
              <div class="widget-item-content d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">{{ w.type | titlecase }}</div>
                  <small class="text-muted">ID: {{ w.id }}</small>
                  <div class="small mt-1 d-flex gap-2">
                    <span class="badge bg-secondary">{{ w.position.x }},{{ w.position.y }}</span>
                    <span class="badge bg-secondary">{{ w.position.w }}×{{ w.position.h }}</span>
                  </div>
                </div>
                <button class="btn btn-sm btn-danger ms-2 flex-shrink-0"
                  (click)="deleteWidget(w); $event.stopPropagation()" title="Delete widget">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
            }
            }
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  @if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  }
</div>