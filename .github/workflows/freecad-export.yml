name: FreeCAD STL Export

on:
  workflow_dispatch:
  workflow_call:

jobs:
  export-stl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install FreeCAD
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common xvfb
        sudo add-apt-repository -y ppa:freecad-maintainers/freecad-stable
        sudo apt-get update
        sudo apt-get install -y freecad
      
    - name: Export STL files
      run: |
        mkdir -p artifacts/stl
        
        # Python script to export all bodies/parts to STL
        cat > export_stl.py << 'EOF'
        import FreeCAD
        import Mesh
        import Import
        import os
        import sys
        
        print("Starting FreeCAD STL export...")
        print(f"Opening file: {sys.argv[1]}")
        
        # Open the FreeCAD file
        doc = FreeCAD.open(sys.argv[1])
        output_dir = sys.argv[2]
        
        print(f"Document opened: {doc.Name}")
        print(f"Total objects in document: {len(doc.Objects)}")
        
        # Define which objects to export
        export_names = ['FrontShield', 'Core', 'BackCover', 'Hook', 'HookBar']
        
        # List all objects and their properties for debugging
        print("\n" + "="*50)
        print("All objects in document:")
        for obj in doc.Objects:
            in_list_count = len(obj.InList) if hasattr(obj, 'InList') else 'N/A'
            has_shape = hasattr(obj, 'Shape') and obj.Shape and not obj.Shape.isNull()
            is_root = not hasattr(obj, 'InList') or len(obj.InList) == 0
            print(f"  - {obj.Label} | Type: {obj.TypeId} | InList: {in_list_count} | Root: {is_root} | HasShape: {has_shape}")
        print("="*50 + "\n")
        
        # Export only specified top-level objects
        exported_count = 0
        for obj in doc.Objects:
            # Check if object is in the export list
            if obj.Label not in export_names:
                continue
            
            # Check if object is at root level
            is_root = not hasattr(obj, 'InList') or len(obj.InList) == 0
            if not is_root:
                print(f"Skipping {obj.Label} - not at root level")
                continue
            print(f"\nProcessing object: {obj.Label} (Type: {obj.TypeId})")
            
            # Check if object has a Shape attribute
            if hasattr(obj, 'Shape') and obj.Shape and not obj.Shape.isNull():
                try:
                    # Check visibility
                    is_visible = True
                    if hasattr(obj, 'ViewObject') and hasattr(obj.ViewObject, 'Visibility'):
                        is_visible = obj.ViewObject.Visibility
                        print(f"  Visibility: {is_visible}")
                    
                    if not is_visible:
                        print(f"  Skipping (not visible)")
                        continue
                    
                    # Create safe filename
                    safe_name = "".join(c for c in obj.Label if c.isalnum() or c in (' ', '-', '_')).rstrip()
                    if not safe_name:
                        safe_name = f"object_{exported_count}"
                    
                    output_file = os.path.join(output_dir, f"{safe_name}.stl")
                    
                    # Export to STL using Mesh module
                    print(f"  Creating mesh...")
                    mesh = Mesh.Mesh(obj.Shape.tessellate(0.1))
                    
                    print(f"  Writing to: {output_file}")
                    mesh.write(output_file)
                    
                    print(f"  ✓ Successfully exported: {obj.Label}")
                    exported_count += 1
                    
                except Exception as e:
                    print(f"  ✗ Failed to export {obj.Label}: {str(e)}")
                    import traceback
                    traceback.print_exc()
            else:
                print(f"  Skipping (no valid Shape)")
        
        print(f"\n{'='*50}")
        print(f"Export complete!")
        print(f"Total objects exported: {exported_count}")
        print(f"{'='*50}")
        
        FreeCAD.closeDocument(doc.Name)
        EOF
        
        # Run FreeCAD in console mode with virtual display to export STL
        xvfb-run --auto-servernum --server-args="-screen 0 1024x768x24" freecad -c "import sys; sys.argv = ['freecad', 'packaging/e-paper-dashboard.FCStd', 'artifacts/stl/']; exec(open('export_stl.py').read())"
        
    - name: List exported files
      run: |
        echo "Exported STL files:"
        ls -lh artifacts/stl/
        
    - name: Upload STL artifacts
      uses: actions/upload-artifact@v4
      with:
        name: freecad-stl-files
        path: artifacts/stl/*.stl
        retention-days: 90
