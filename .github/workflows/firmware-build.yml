name: Firmware Build

on:
  workflow_call:
    outputs:
      version:
        description: 'Firmware version'
        value: ${{ jobs.build.outputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          ~/.cache/pip
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Build firmware
      working-directory: ./firmware
      run: pio run
      
    - name: Get version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          # Extract version from tag (e.g., v1.2.3 or v1.2.3.4)
          VERSION=${GITHUB_REF#refs/tags/v}
          # Validate numeric version format
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Error: Tag must follow format v{major}.{minor}.{patch} or v{major}.{minor}.{patch}.{build}"
            exit 1
          fi
        else
          # For non-tag builds, use 0.0.0 (dotnet compatible)
          VERSION="0.0.0"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Firmware version: $VERSION"
        
    - name: Prepare artifacts
      run: |
        mkdir -p artifacts
        cp firmware/.pio/build/esp32dev/firmware.bin artifacts/firmware-${{ steps.version.outputs.version }}.bin
        cp firmware/.pio/build/esp32dev/firmware.elf artifacts/firmware-${{ steps.version.outputs.version }}.elf
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-esp32-${{ steps.version.outputs.version }}
        path: artifacts/
        retention-days: 90
