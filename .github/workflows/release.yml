name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  # Build all components
  build-firmware:
    uses: ./.github/workflows/firmware-build.yml
    
  build-software:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    permissions:
      contents: read
      
  build-packaging:
    uses: ./.github/workflows/freecad-export.yml
    
  # Create unified release with all artifacts
  create-release:
    needs: [build-firmware, build-software, build-packaging]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get tag version
      id: tag
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        
    - name: Download firmware artifacts
      uses: actions/download-artifact@v4
      with:
        name: firmware-esp32-${{ needs.build-firmware.outputs.version }}
        path: ./release/firmware/
        
    - name: Download STL artifacts
      uses: actions/download-artifact@v4
      with:
        name: freecad-stl-files
        path: ./release/stl/
        
    - name: Create release archive
      run: |
        cd release
        zip -r ../e-paper-dashboard-${{ steps.tag.outputs.version }}-complete.zip .
        cd ..
        
    - name: Create release body
      id: release_body
      run: |
        cat > release_body.md << 'EOF'
        ## Docker Image
        
        ```bash
        # Specific version
        docker pull izdevdigital/e-paper-dashboard:${{ steps.tag.outputs.version }}
        
        # Latest
        docker pull izdevdigital/e-paper-dashboard:latest
        ```
        
        [View on Docker Hub](https://hub.docker.com/r/izdevdigital/e-paper-dashboard)
        
        ---
        
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Release ${{ steps.tag.outputs.version }}
        draft: false
        prerelease: ${{ contains(steps.tag.outputs.version, '-') }}
        generate_release_notes: true
        body_path: release_body.md
        files: |
          release/firmware/*.bin
          release/firmware/*.elf
          release/stl/*.stl
          e-paper-dashboard-${{ steps.tag.outputs.version }}-complete.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release Summary
      run: |
        echo "### âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Firmware (ESP32)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker Image: \`izdevdigital/e-paper-dashboard:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 3D Models (STL)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Complete Package (ZIP)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Links:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ [Docker Hub](https://hub.docker.com/r/izdevdigital/e-paper-dashboard)" >> $GITHUB_STEP_SUMMARY
